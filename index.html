<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Pixel City Card Game</title>
<style>
  body { margin:0; overflow:hidden; background:#222; font-family:sans-serif; }
  canvas { display:block; background:#444; }
  #hand {
    position:absolute;
    bottom:0;
    left:50%;
    transform:translateX(-50%);
    width:100%;
    height:150px;
    pointer-events:none;
  }
  .card {
    width:80px;
    height:120px;
    background:#eee;
    border:2px solid #999;
    border-radius:8px;
    position:absolute;
    cursor:pointer;
    user-select:none;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:bold;
    pointer-events:auto;
    transition: transform 0.2s;
  }
</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="hand"></div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const HEX_SIZE = 50;
const MAP_RADIUS = 3;
let hexMap = [];
let hoveredHex = null;
let cards = [];

const handDiv = document.getElementById("hand");

// ================== HEX MAP ==================
function axialToWorld(q,r){
    let x = HEX_SIZE * 3/2 * q;
    let y = HEX_SIZE * Math.sqrt(3) * (r + q/2);
    return {x:x + canvas.width/2, y:y + canvas.height/2};
}

function drawHex(x,y,size,color){
    ctx.beginPath();
    for(let i=0;i<6;i++){
        let angle = Math.PI/180*(60*i-30);
        let px = x + size*Math.cos(angle);
        let py = y + size*Math.sin(angle);
        if(i===0) ctx.moveTo(px,py);
        else ctx.lineTo(px,py);
    }
    ctx.closePath();
    ctx.fillStyle=color;
    ctx.fill();
    ctx.strokeStyle="#000";
    ctx.stroke();
}

function generateMap(){
    hexMap = [];
    for(let q=-MAP_RADIUS;q<=MAP_RADIUS;q++){
        let r1 = Math.max(-MAP_RADIUS, -q-MAP_RADIUS);
        let r2 = Math.min(MAP_RADIUS, -q+MAP_RADIUS);
        for(let r=r1;r<=r2;r++){
            let pos = axialToWorld(q,r);
            hexMap.push({q,r,x:pos.x,y:pos.y,building:null,discovered:true});
        }
    }
}

function drawMap(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(let hex of hexMap){
        let color = hex.discovered ? "#ccc" : "#666";
        if(hoveredHex && hoveredHex.q===hex.q && hoveredHex.r===hex.r) color="#ffa";
        drawHex(hex.x,hex.y,HEX_SIZE,color);
        if(hex.building){
            // budynek pixel art placeholder
            ctx.fillStyle="red";
            ctx.fillRect(hex.x-10, hex.y-10, 20,20);
        }
    }
}

function pixelToAxial(px,py){
    let x = px - canvas.width/2;
    let y = py - canvas.height/2;
    let q = (2/3*x)/HEX_SIZE;
    let r = (-1/3*x + Math.sqrt(3)/3*y)/HEX_SIZE;
    let rx = Math.round(q);
    let rz = Math.round(r);
    return {q:rx,r:rz};
}

function getHex(q,r){
    return hexMap.find(h => h.q===q && h.r===r);
}

// ================== CARDS ==================
function createCard(name,type){
    let div = document.createElement("div");
    div.className="card";
    div.innerText=name;
    div.dataset.type=type;
    handDiv.appendChild(div);
    cards.push(div);

    div.onmousedown = function(e){
        e.preventDefault();
        let offsetX = e.clientX - div.getBoundingClientRect().x;
        let offsetY = e.clientY - div.getBoundingClientRect().y;

        function moveHandler(ev){
            div.style.left=(ev.clientX-offsetX)+"px";
            div.style.top=(ev.clientY-offsetY)+"px";
        }
        function upHandler(ev){
            document.removeEventListener("mousemove",moveHandler);
            document.removeEventListener("mouseup",upHandler);
            let pos = pixelToAxial(ev.clientX, ev.clientY);
            let hex = getHex(pos.q,pos.r);
            if(hex){
                if(div.dataset.type==="building") hex.building=true;
            }
            arrangeCards(); // wraca karta do wachlarza
        }
        document.addEventListener("mousemove",moveHandler);
        document.addEventListener("mouseup",upHandler);
    }
}

// ================== FAN ARRANGEMENT ==================
function arrangeCards(){
    let n = cards.length;
    let radius = 200;
    let centerX = window.innerWidth/2;
    let baseY = window.innerHeight - 50;
    let maxAngle = 60;
    let mid = (n-1)/2;
    cards.forEach((card,i)=>{
        let t = i-mid;
        let angle = (t/mid)*(maxAngle/2)*Math.PI/180; // convert to rad
        let px = radius * Math.sin(angle);
        let py = -radius*(1-Math.cos(angle))*0.5;
        card.style.left = (centerX+px-40)+"px"; // 40 = half card width
        card.style.top = (baseY+py-60)+"px"; // 60 = half card height
        card.style.transform = `rotate(${angle}rad)`;
    });
}

// ================== INIT ==================
generateMap();
createCard("House","building");
createCard("Farm","building");
arrangeCards();

// ================== ANIM LOOP ==================
canvas.onmousemove = function(e){
    let pos = pixelToAxial(e.clientX,e.clientY);
    hoveredHex = getHex(pos.q,pos.r);
}

function gameLoop(){
    drawMap();
    requestAnimationFrame(gameLoop);
}
gameLoop();

</script>
</body>
</html>
