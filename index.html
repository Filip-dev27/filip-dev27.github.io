<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Pixel City Max Prototype</title>
<style>
body { margin:0; overflow:hidden; background:#222; font-family:sans-serif; }
canvas { display:block; background:#444; }
#hand {
    position:absolute;
    bottom:0;
    left:50%;
    transform:translateX(-50%);
    width:100%;
    height:200px;
    pointer-events:none;
}
.card {
    width:80px;
    height:120px;
    background:#eee;
    border:2px solid #999;
    border-radius:8px;
    position:absolute;
    cursor:pointer;
    user-select:none;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:bold;
    pointer-events:auto;
    transition: transform 0.2s;
}
</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="hand"></div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const HEX_SIZE = 50;
const MAP_RADIUS = 3;
let hexMap = [];
let hoveredHex = null;
let cards = [];

const handDiv = document.getElementById("hand");

// ================== PIXEL-ART ASSETS (placeholder) ==================
const images = {};
images.house = new Image();
images.house.src = "https://i.imgur.com/8l1AxHz.png";
images.farm = new Image();
images.farm.src = "https://i.imgur.com/0a1bE8v.png";
images.people = new Image();
images.people.src = "https://i.imgur.com/O3kzQEZ.png"; // np. postać
images.special = new Image();
images.special.src = "https://i.imgur.com/Mx3hFSp.png"; // efekt specjalny

// ================== HEX MAP ==================
function axialToWorld(q,r){
    let x = HEX_SIZE * 3/2 * q;
    let y = HEX_SIZE * Math.sqrt(3) * (r + q/2);
    return {x:x + canvas.width/2, y:y + canvas.height/2};
}

function drawHex(x,y,size,color){
    ctx.beginPath();
    for(let i=0;i<6;i++){
        let angle = Math.PI/180*(60*i-30);
        let px = x + size*Math.cos(angle);
        let py = y + size*Math.sin(angle);
        if(i===0) ctx.moveTo(px,py);
        else ctx.lineTo(px,py);
    }
    ctx.closePath();
    ctx.fillStyle=color;
    ctx.fill();
    ctx.strokeStyle="#000";
    ctx.stroke();
}

function generateMap(){
    hexMap = [];
    for(let q=-MAP_RADIUS;q<=MAP_RADIUS;q++){
        let r1 = Math.max(-MAP_RADIUS, -q-MAP_RADIUS);
        let r2 = Math.min(MAP_RADIUS, -q+MAP_RADIUS);
        for(let r=r1;r<=r2;r++){
            let pos = axialToWorld(q,r);
            hexMap.push({
                q,r,
                x:pos.x,
                y:pos.y,
                building:null,
                population:0,
                discovered:true,
                animProgress:0
            });
        }
    }
}

function drawMap(delta){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(let hex of hexMap){
        let color = hex.discovered ? "#ccc" : "#666";
        if(hoveredHex && hoveredHex.q===hex.q && hoveredHex.r===hex.r) color="#ffa";
        drawHex(hex.x,hex.y,HEX_SIZE,color);

        // budynek z animacją
        if(hex.building){
            if(hex.animProgress<1) hex.animProgress += delta*0.01;
            let scale = Math.min(hex.animProgress,1);
            let img = images[hex.building];
            ctx.save();
            ctx.translate(hex.x,hex.y);
            ctx.scale(scale,scale);
            ctx.drawImage(img,-img.width/2,-img.height/2);
            ctx.restore();
        }

        // populacja
        if(hex.population>0){
            ctx.fillStyle="blue";
            ctx.font="16px sans-serif";
            ctx.textAlign="center";
            ctx.fillText(hex.population,hex.x,hex.y+HEX_SIZE/2);
        }
    }
}

function pixelToAxial(px,py){
    let x = px - canvas.width/2;
    let y = py - canvas.height/2;
    let q = (2/3*x)/HEX_SIZE;
    let r = (-1/3*x + Math.sqrt(3)/3*y)/HEX_SIZE;
    let rx = Math.round(q);
    let rz = Math.round(r);
    return {q:rx,r:rz};
}

function getHex(q,r){
    return hexMap.find(h => h.q===q && h.r===r);
}

// ================== CARDS ==================
function createCard(name,type,imgKey){
    let div = document.createElement("div");
    div.className="card";
    div.innerText=name;
    div.dataset.type=type;
    div.dataset.img=imgKey;
    handDiv.appendChild(div);
    cards.push(div);

    div.onmousedown = function(e){
        e.preventDefault();
        div.style.zIndex=1000;
        let offsetX = e.clientX - div.getBoundingClientRect().x;
        let offsetY = e.clientY - div.getBoundingClientRect().y;

        div.style.transform+=" scale(1.2)";
        function moveHandler(ev){
            div.style.left=(ev.clientX-offsetX)+"px";
            div.style.top=(ev.clientY-offsetY)+"px";
        }
        function upHandler(ev){
            document.removeEventListener("mousemove",moveHandler);
            document.removeEventListener("mouseup",upHandler);
            div.style.transform=div.style.transform.replace(" scale(1.2)","");
            let pos = pixelToAxial(ev.clientX, ev.clientY);
            let hex = getHex(pos.q,pos.r);
            if(hex){
                switch(div.dataset.type){
                    case "building": hex.building=div.dataset.img; hex.animProgress=0; break;
                    case "people": hex.population+=1; break;
                    case "special": hex.building=null; break;
                    case "discover":
                        getNeighbors(hex).forEach(n=>{
                            let h = getHex(n.q,n.r);
                            if(h) h.discovered=true;
                        });
                        break;
                }
            }
            arrangeCards();
        }
        document.addEventListener("mousemove",moveHandler);
        document.addEventListener("mouseup",upHandler);
    }
}

// ================== FAN ARRANGEMENT ==================
function arrangeCards(){
    let n = cards.length;
    let radius = 200;
    let centerX = window.innerWidth/2;
    let baseY = window.innerHeight - 50;
    let maxAngle = 60;
    let mid = (n-1)/2;
    cards.forEach((card,i)=>{
        let t = i-mid;
        let angle = (t/mid)*(maxAngle/2)*Math.PI/180; 
        let px = radius * Math.sin(angle);
        let py = -radius*(1-Math.cos(angle))*0.5;
        card.style.left = (centerX+px-40)+"px";
        card.style.top = (baseY+py-60)+"px";
        card.style.transform = `rotate(${angle}rad)`;
    });
}

// ================== NEIGHBORS ==================
function getNeighbors(hex){
    const dirs = [
        {q:1,r:0},{q:1,r:-1},{q:0,r:-1},
        {q:-1,r:0},{q:-1,r:1},{q:0,r:1}
    ];
    return dirs.map(d=>({q:hex.q+d.q,r:hex.r+d.r}));
}

// ================== INIT ==================
generateMap();
createCard("House","building","house");
createCard("Farm","building","farm");
createCard("Person","people","people");
createCard("Destroy","special","special");
createCard("Discover","discover","special");
arrangeCards();

// ================== ANIM LOOP ==================
let lastTime = performance.now();
canvas.onmousemove = function(e){
    let pos = pixelToAxial(e.clientX,e.clientY);
    hoveredHex = getHex(pos.q,pos.r);
}

function gameLoop(time){
    let delta = time - lastTime;
    lastTime = time;
    drawMap(delta);
    requestAnimationFrame(gameLoop);
}
gameLoop();

</script>
</body>
</html>
